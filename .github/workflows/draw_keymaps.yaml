name: Keymap Drawer

on:
  push:
    branches:
      - main  # Change this to the branch you want to trigger the workflow on

jobs:
  keymap-drawer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'  # Ensure this matches the Python version you need

      - name: Install pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          export PATH="${HOME}/.local/bin:$PATH"

      - name: Install keymap-drawer
        run: |
          pipx install keymap-drawer

      - name: Install QMK CLI
        run: |
          python3 -m pip install --user qmk
          echo "${HOME}/.local/bin" >> $GITHUB_PATH
          export PATH="${HOME}/.local/bin:$PATH"

      - name: Verify QMK CLI version
        run: |
          qmk --version

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          sudo apt-get install -y gcc-avr binutils-avr avr-libc
          sudo apt-get install -y avrdude
          sudo apt-get install -y dfu-programmer
          sudo apt-get install -y dfu-util

      - name: Set up QMK environment
        run: |
          qmk setup -y

      - name: Verify QMK CLI after setup
        run: |
          qmk --version

      - name: Run qmk c2json
        run: |
          qmk c2json ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.c > ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json

      - name: Check qmk c2json output
        run: |
          cat ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json || echo "c2.json not created"

      - name: Run keymap parse
        run: |
          keymap parse -c 12 -q ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json > ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.yaml

      - name: Replace problematic characters in keymap.yaml
        run: |
          sed -i "s/��/''/g" ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.yaml

      - name: Run keymap-drawer for keymap.yaml
        run: |
          keymap -c ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/config.yaml draw ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.yaml > ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.svg

      - name: Run keymap-drawer for keymapDesign.yaml
        run: |
          keymap -c ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/config.yaml draw ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.yaml > ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.svg

      - name: Commit and push updated files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json
          git add ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.json
          git add ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.svg
          git add ${{ github.workspace }}/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.svg
          git commit -m "Update keymap JSON and SVG files"
          git push
