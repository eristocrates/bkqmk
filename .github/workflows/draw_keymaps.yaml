name: Keymap Drawer

on:
  push:
    branches:
      - main  # Change this to the branch you want to trigger the workflow on

jobs:
  keymap-drawer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'  # Ensure this matches the Python version you need

      - name: Install keymap-drawer
        run: |
          pip install keymap-drawer

      - name: Install QMK CLI
        run: |
          pip install qmk

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi
          sudo apt-get install -y gcc-avr binutils-avr avr-libc
          sudo apt-get install -y avrdude
          sudo apt-get install -y dfu-programmer
          sudo apt-get install -y dfu-util

      - name: Clone qmk_firmware
        run: |
          git clone https://github.com/qmk/qmk_firmware.git
          cd qmk_firmware
          git submodule update --init --recursive

      - name: Set up QMK environment
        run: |
          cd qmk_firmware
          qmk setup

      - name: Run qmk c2json
        run: |
          keymap_c_path=$(pwd)/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.c
          c2_json_path=$(pwd)/keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json
          qmk c2json $keymap_c_path > $c2_json_path

      - name: Run keymap parse
        run: |
          keymap parse ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json > ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.json

      - name: Replace problematic characters in keymap.yaml
        run: |
          sed -i "s/��/''/g" ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.yaml

      - name: Run keymap-drawer for keymap.yaml
        run: |
          keymap -c ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/config.yaml draw ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.yaml > ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.svg

      - name: Run keymap-drawer for keymapDesign.yaml
        run: |
          keymap -c ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/config.yaml draw ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.yaml > ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.svg

      - name: Commit and push updated files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/c2.json
          git add ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.json
          git add ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymap.svg
          git add ./keyboards/bastardkb/charybdis/3x6/keymaps/brainrot/keymapDesign.svg
          git commit -m "Update keymap JSON and SVG files"
          git push
